<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פסוק אישי לפי שם - סגולה ליום הדין</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Frank+Ruhl+Libre:wght@700&family=Assistant:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* --- General Styling --- */
        :root {
            --primary-color: #0D2B45; /* כחול עמוק */
            --secondary-color: #205375; /* כחול ביניים */
            --accent-color: #c09f80; /* זהב/ברונזה עדין */
            --background-color: #f8f6f2; /* רקע אוף-ווייט חם */
            --text-color: #333D45; /* אפור-כחול כהה לטקסט */
            --light-bg: #FFFFFF; /* לבן */
            --result-bg: #fffaf0; /* קרם בהיר לתוצאה */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            line-height: 1.7;
            background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png');
        }

        /* --- Container --- */
        .container {
            width: 100%;
            max-width: 750px;
            background-color: var(--light-bg);
            padding: 40px 50px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            text-align: center;
            border-top: 5px solid var(--primary-color);
        }

        /* --- Typography --- */
        h1 {
            font-family: 'Frank Ruhl Libre', serif;
            color: var(--primary-color);
            font-size: 2.8em;
            margin-bottom: 15px;
        }

        .explanation {
            max-width: 600px;
            margin: 0 auto 30px auto;
            font-size: 1.1em;
            color: #555;
        }

        strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        /* --- Search Area --- */
        .search-area {
            margin-top: 30px;
            padding: 30px;
            background-color: #f7f9fc;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
        }

        label {
            font-size: 1.25em;
            font-weight: 600;
            color: var(--secondary-color);
        }

        input[type="text"] {
            width: 70%;
            padding: 12px 15px;
            margin-top: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1.2em;
            text-align: right;
            font-family: 'Assistant', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(192, 159, 128, 0.2);
        }

        button {
            display: block;
            width: 50%;
            margin: 20px auto 0 auto;
            padding: 14px 28px;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--light-bg);
            background-color: var(--accent-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover:not(:disabled) {
            background-color: #a88a6d; /* גוון כהה יותר של הצבע */
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }

        /* --- Result Area --- */
        #result {
            margin-top: 35px;
            padding: 25px;
            background-color: var(--result-bg);
            border: 1px solid #e9e0d3;
            border-radius: 8px;
            min-height: 60px;
            font-size: 1.4em;
            font-weight: 600;
            line-height: 1.8;
            color: var(--text-color);
        }
        
        #result.fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .reference {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-top: 15px;
            font-weight: 400;
        }

        .match-counter {
            font-size: 0.8rem;
            color: #777;
            font-weight: 400;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>פסוק אישי לפי שם</h1>

        <div class="explanation">
            <p><strong>סגולה שלא ישכח שמו ליום הדין:</strong> יאמר קודם "יהיו לרצון" השני בתפילת העמידה, פסוק מהתנ"ך המתחיל באות הראשונה של שמו ומסתיים באות האחרונה של שמו, או פסוק ששמו מופיע בו. להלן פסוקי התנ"ך ממויינים לפי האות הראשונה והאחרונה שלהם.</p>
        </div>

        <div class="search-area">
            <label for="nameInput">הכניסו שם ולחצו לחיפוש הפסוק</label><br>
            <input type="text" id="nameInput" placeholder="לדוגמא: דניאל">
            <br>
            <button id="searchButton" onclick="findVerse()">מצא את הפסוק שלי</button>
        </div>

        <div id="result">
            <p id="status">טוען את חמשת חומשי תורה מ-Sefaria, אנא המתן בסבלנות...</p>
        </div>
    </div>

    <script>
        // --- Global Variables for State Management ---
        let allVerses = [];
        let currentMatches = [];
        let currentMatchIndex = 0;
        let lastSearchedName = '';

        // --- DOM Elements ---
        const searchButton = document.getElementById('searchButton');
        const nameInput = document.getElementById('nameInput');
        const statusP = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        
        searchButton.disabled = true;

        const torahStructure = {
            'Genesis': { name: 'בראשית', chapters: 50 }, 'Exodus': { name: 'שמות', chapters: 40 },
            'Leviticus': { name: 'ויקרא', chapters: 27 }, 'Numbers': { name: 'במדבר', chapters: 36 },
            'Deuteronomy': { name: 'דברים', chapters: 34 }
        };

        // --- Loading Function ---
        async function loadAllTorahBooks() {
            let chapterRequests = [];
            for (const book in torahStructure) {
                for (let i = 1; i <= torahStructure[book].chapters; i++) {
                    chapterRequests.push(fetch(`https://www.sefaria.org/api/texts/${book}.${i}`));
                }
            }
            statusP.textContent = `טוען ${chapterRequests.length} פרקים מהרשת...`;

            try {
                const responses = await Promise.all(chapterRequests);
                const chapterDataPromises = responses.map(res => res.json());
                const allChapterData = await Promise.all(chapterDataPromises);
                statusP.textContent = 'מעבד את הנתונים...';

                allChapterData.forEach(chapterInfo => {
                    const hebrewReference = chapterInfo.heRef;
                    const versesInChapter = chapterInfo.he;
                    if (Array.isArray(versesInChapter)) {
                        versesInChapter.forEach((verseText, verseIndex) => {
                            allVerses.push({
                                text: verseText,
                                reference: `${hebrewReference}, ${String.fromCharCode(1488 + verseIndex)}׳`
                            });
                        });
                    }
                });
                
                statusP.textContent = `המאגר נטען (${allVerses.length.toLocaleString()} פסוקים). ניתן לחפש.`;
                searchButton.disabled = false;

            } catch (error) {
                console.error('Sefaria API Error:', error);
                statusP.textContent = 'שגיאת רשת: לא ניתן היה להתחבר למאגר של Sefaria. אנא בדוק את חיבור האינטרנט ורענן.';
                statusP.style.color = 'red';
            }
        }

        // --- Main Search Function ---
        function findVerse() {
            const currentName = nameInput.value.trim();
            if (currentName.length < 2) {
                resultDiv.innerHTML = '<p>אנא הכנס שם בעל שתי אותיות לפחות.</p>';
                return;
            }

            // Check if it's a new search or a request for the next match
            if (currentName !== lastSearchedName) {
                // This is a new search
                lastSearchedName = currentName;
                const firstLetter = currentName[0];
                const lastLetter = currentName[currentName.length - 1];
                
                const getNormalizedLetter = (letter) => {
                    const finalLetters = { 'ך': 'כ', 'ם': 'מ', 'ן': 'נ', 'ף': 'פ', 'ץ': 'צ' };
                    return finalLetters[letter] || letter;
                };
                const normalizedLastLetter = getNormalizedLetter(lastLetter);
                
                // Find all matches, not just the first one
                currentMatches = allVerses.filter(item => {
                    const text = item.text.replace(/<[^>]*>/g, '');
                    const words = text.split(' ');
                    if (words.length === 0) return false;
                    const firstWord = words[0];
                    const lastWord = words[words.length - 1];
                    if (!firstWord || !lastWord) return false;
                    const verseFirstLetter = firstWord[0];
                    let verseLastLetter = lastWord.slice(-1);
                    if ('.,?!;׃'.includes(verseLastLetter)) {
                        verseLastLetter = (lastWord.length > 1) ? lastWord.slice(-2, -1) : lastWord[0];
                    }
                    return verseFirstLetter === firstLetter && getNormalizedLetter(verseLastLetter) === normalizedLastLetter;
                });
                
                currentMatchIndex = 0;

                if (currentMatches.length === 0) {
                    resultDiv.innerHTML = `<p>לא נמצא פסוק מתאים לשם '${currentName}' בחמשת חומשי תורה.</p>`;
                    resultDiv.classList.add('fade-in');
                    return;
                }
            } else {
                // This is a request for the next verse from the existing matches
                if (currentMatches.length <= 1) return; // No other verses to show
                currentMatchIndex++;
                if (currentMatchIndex >= currentMatches.length) {
                    currentMatchIndex = 0; // Loop back to the beginning
                }
            }
            
            displayCurrentVerse();
        }

        // --- Helper function to display the verse ---
        function displayCurrentVerse() {
            if (!currentMatches[currentMatchIndex]) return;

            const verse = currentMatches[currentMatchIndex];
            let matchCounterHTML = '';

            // Show a counter if more than one match was found
            if (currentMatches.length > 1) {
                matchCounterHTML = `<span class="match-counter">(פסוק ${currentMatchIndex + 1} מתוך ${currentMatches.length})</span>`;
            }

            resultDiv.classList.remove('fade-in');
            void resultDiv.offsetWidth; // Trigger reflow to restart animation

            resultDiv.innerHTML = `
                <p>${verse.text.replace(/<[^>]*>/g, '')}</p>
                <p class="reference">
                    ${verse.reference}
                    ${matchCounterHTML}
                </p>
            `;
            
            resultDiv.classList.add('fade-in');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', loadAllTorahBooks);

        // Add event listener for the "Enter" key on the input field
        nameInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !searchButton.disabled) {
                event.preventDefault(); // Prevent default behavior (like form submission)
                findVerse();
            }
        });
    </script>
</body>
</html>
